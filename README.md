# Allo Protocol Indexer

The Allo Protocol Indexer is a tool that indexes blockchain events generated by [Allo contracts](https://github.com/Allo-Protocol/contracts) and serving the data over HTTP in JSON format. The data is organized in a specific structure that enables easy access to different parts of the protocol. The indexer is built using [Chainsauce](https://github.com/boudra/chainsauce) and is designed to work with any EVM-compatible chain.

The indexer data is used by [Grants Stack](https://github.com/gitcoinco/grants-stack) to show stats and allocate matching funds.

# Indexed Data

Access indexed data through this URL: https://indexer-grants-stack.gitcoin.co

The indexed data follows this structure:

```
/{chainId}/rounds.json
/{chainId}/prices.json
/{chainId}/projects.json
/{chainId}/rounds/{roundId}/projects.json
/{chainId}/rounds/{roundId}/projects/{projectId}/votes.json
/{chainId}/rounds/{roundId}/projects/{projectId}/contributors.json
/{chainId}/rounds/{roundId}/applications.json
/{chainId}/rounds/{roundId}/applications/{applicationIndex}/votes.json
/{chainId}/rounds/{roundId}/votes.json
/{chainId}/rounds/{roundId}/contributors.json
```

The indexer is monitoring the following chains with their respective chain IDs:

- Ethereum Mainnet: 1
- Ethereum Goerli Testnet: 5
- Optimism: 10
- Fantom: 250

## How to run?

### Production:

```bash
npm install
npm run build
npm run start
```

### Development:

**Make sure you set the environment variables before running, find a `.env` template in `.env.example`**

```bash
npm install
npm run build:watch
npm run dev
```

The HTTP server runs on port 4000, check it here: http://localhost:4000/

It shouldn't have any data because you probably haven't indexed anything yet. Check [the indexing section](#Indexing) to see how to index data.

#### Indexing

Indexed JSON data is found in the `data` directory.

To only index data without tracking new events nor starting a server, provide the `--run-once` option:

```
npm run start -- --chains=mainnet,goerli --run-once
```

## Deployment

We deploy the Docker image to Fly, check [fly.production.toml](https://github.com/gitcoinco/allo-indexer/blob/main/fly.production.toml) and [Dockerfile](https://github.com/gitcoinco/allo-indexer/blob/main/Dockerfile) files for more details.

**Notes about the deployment**

- `main` continuously deploys to https://indexer-staging.fly.dev/
- `release` continuously deploys to https://indexer-grants-stack.gitcoin.co/data/
- On deploy the data directory is always cleared and everything is reindexed, we only persist the cache
- Find the data directory at `/mnt/indexer/data` and the cache directory at `/mnt/indexer/cache`

The following commands might be useful for monitoring (use the `-c [fly.production.toml|fly.staging.toml]` argument switch between staging and production:

```bash
fly status # show general status of the app, all VMs and their status
fly -c fly.staging.toml status # status of staging
fly logs # check logs of running VM, it also shows logs of deployments in progress
fly -c fly.staging.toml logs # check logs of staging
fly ssh console # open a console to the runnning VM
```
